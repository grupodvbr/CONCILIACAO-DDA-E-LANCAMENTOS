<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Conferência de Lançamentos F360 X DDA</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header {
      display: flex; align-items: center; gap: 15px; padding: 10px 20px;
      border-bottom: 2px solid #ccc; background: #fff; position: sticky; top: 0; z-index: 1000;
    }
    header img { height: 40px; }
    header h1 { margin: 0; font-size: 1.6em; font-weight: bold; }
    .topo-fixo {
      display: flex; align-items: center; gap: 10px; padding: 10px 20px;
      background: #f8f8f8; position: sticky; top: 62px; z-index: 999; border-bottom: 1px solid #ddd;
    }
    .topo-fixo button {
      padding: 6px 15px; background-color: #007bff; color: white;
      border: none; border-radius: 6px; cursor: pointer;
    }
    .topo-fixo .limpar { background-color: #dc3545; }
    main { display: flex; gap: 20px; padding: 20px; height: calc(100vh - 160px); box-sizing: border-box; }
    .coluna {
      flex: 1; background: #fff; border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1); display: flex;
      flex-direction: column; height: 100%; overflow: hidden;
    }
    .coluna-header {
      padding: 10px; font-size: 1.2em; font-weight: bold;
      border-bottom: 1px solid #ccc; background: #fff; flex-shrink: 0;
    }
    .coluna-scroll { overflow-y: auto; padding: 10px; }
    .card {
      border: 2px solid #ccc; border-left: 5px solid orange; border-radius: 8px;
      padding: 10px; margin-bottom: 10px; background: #fff;
    }
    .match { border-left-color: green; background: #e9fbe9; }
    .valor { font-weight: bold; }
    #totais {
      padding: 10px 20px; font-weight: bold; background: #fff;
      border-top: 1px solid #ccc;
    }
    #qtdeConciliado { color: green; }
    #qtdePendente { color: orange; }
    #valorConciliado, #valorPendente {
      padding: 2px 6px; border-radius: 4px; color: white;
    }
    #valorConciliado { background: green; }
    #valorPendente { background: orange; }
  </style>
</head>
<body>
  <header>
    <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo CB Systems" />
    <h1>Conferência de Lançamentos F360 X DDA</h1>
  </header>

  <div class="topo-fixo">
    <input type="file" id="contas" accept=".xlsx,.xls" onchange="mostrarArquivo('contas')" hidden />
    <button onclick="document.getElementById('contas').click()">Escolher Arquivo Excel</button>

    <button onclick="abrirModalDDA()">Adicionar DDA por Empresa</button>
    <button onclick="conciliar()">Comparar</button>
    <button class="limpar" onclick="limparHistorico()">Limpar Histórico</button>
  </div>

  <main>
    <div class="coluna">
      <div class="coluna-header">Contas a pagar F360</div>
      <div class="coluna-scroll" id="sistema"></div>
    </div>
    <div class="coluna">
      <div class="coluna-header">
        Boletos no DDA
        <select id="filtroEmpresaDDA" onchange="filtrarPorEmpresa()">
          <option value="">Todas</option>
          <option value="MERCATTO DELÍCIA">MERCATTO DELÍCIA</option>
          <option value="VILLA GOURMET">VILLA GOURMET</option>
          <option value="PADARIA DELÍCIA">PADARIA DELÍCIA</option>
          <option value="M. KIDS">M. KIDS</option>
          <option value="DELICIA GOURMET">DELICIA GOURMET</option>
        </select>
      </div>
      <div class="coluna-scroll" id="banco"></div>
    </div>
  </main>

  <div id="totais">
    Conciliados: <span id="qtdeConciliado">0</span> |
    Pendentes: <span id="qtdePendente">0</span> |
    Valor Conciliado: <span id="valorConciliado">R$ 0,00</span> |
    Valor Pendente: <span id="valorPendente">R$ 0,00</span>
  </div>

  <div id="modalDDA" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:#000000aa; align-items:center; justify-content:center; z-index:2000;">
    <div style="background:white; padding:20px; border-radius:10px; width:300px;">
      <h3>Escolha a empresa</h3>
      <select id="empresaSelecionada">
        <option value="">Selecione...</option>
        <option value="MERCATTO DELÍCIA">MERCATTO DELÍCIA</option>
        <option value="VILLA GOURMET">VILLA GOURMET</option>
        <option value="PADARIA DELÍCIA">PADARIA DELÍCIA</option>
        <option value="M. KIDS">M. KIDS</option>
        <option value="DELICIA GOURMET">DELICIA GOURMET</option>
      </select>
      <input type="file" id="uploadEmpresaDDA" accept="application/pdf" style="margin-top:10px;">
      <br>
      <button onclick="carregarPDFEmpresa()">Carregar PDF</button>
      <button onclick="fecharModalDDA()">Fechar</button>
    </div>
  </div>

  <script>
    let dadosDDAporEmpresa = {};

    function abrirModalDDA() {
      document.getElementById("modalDDA").style.display = "flex";
    }
    function fecharModalDDA() {
      document.getElementById("modalDDA").style.display = "none";
    }

    function salvarLocal(nome, dados) {
      localStorage.setItem(nome, JSON.stringify(dados));
    }
    function lerLocal(nome) {
      return JSON.parse(localStorage.getItem(nome) || '[]');
    }

    function carregarPDFEmpresa() {
      const empresa = document.getElementById("empresaSelecionada").value;
      const file = document.getElementById("uploadEmpresaDDA").files[0];
      if (!empresa || !file) return alert("Preencha tudo");

      const reader = new FileReader();
      reader.onload = function () {
        const typedarray = new Uint8Array(this.result);
        pdfjsLib.getDocument({ data: typedarray }).promise.then(function (pdf) {
          let allText = '';
          let promises = [];
          for (let i = 1; i <= pdf.numPages; i++) {
            promises.push(pdf.getPage(i).then(page => page.getTextContent().then(tc => {
              allText += tc.items.map(item => item.str).join('\n') + '\n';
            })));
          }
          Promise.all(promises).then(() => {
            const linhas = allText.split('\n');
            const resultados = [];
            for (let linha of linhas) {
              const match = linha.trim().match(/(.+?)\s+(\d{2}\/\d{2}\/\d{4})\s+(\d{1,3}(?:\.\d{3})*,\d{2})$/);
              if (match) {
                const fornecedor = match[1].trim();
                const data = match[2];
                const valor = parseFloat(match[3].replace(/\./g, '').replace(',', '.'));
                if (!isNaN(valor)) resultados.push({ valor: valor.toFixed(2), fornecedor, data, empresa });
              }
            }
            if (!dadosDDAporEmpresa[empresa]) dadosDDAporEmpresa[empresa] = [];
            dadosDDAporEmpresa[empresa] = dadosDDAporEmpresa[empresa].concat(resultados);
            salvarLocal('dda', Object.values(dadosDDAporEmpresa).flat());
            alert("PDF carregado!"); fecharModalDDA(); filtrarPorEmpresa();
          });
        });
      };
      reader.readAsArrayBuffer(file);
    }

    function mostrarArquivo(tipo) {
      const input = document.getElementById(tipo);
      if (tipo === 'contas') {
        const reader = new FileReader();
        reader.onload = function (e) {
          const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          const resultados = [];
          for (let i = 1; i < data.length; i++) {
            const linha = data[i];
            if (!linha || linha.length < 9) continue;
            const valor = parseFloat(linha[8]);
            if (!isNaN(valor)) {
              resultados.push({ valor: valor.toFixed(2), fornecedor: linha[4] || '', data: linha[6] || '', cod: linha[1] || '' });
            }
          }
          salvarLocal('contas', resultados);
        };
        reader.readAsArrayBuffer(input.files[0]);
      }
    }

    function filtrarPorEmpresa() {
      const empresa = document.getElementById("filtroEmpresaDDA").value;
      const todos = lerLocal('dda');
      const filtrado = empresa ? todos.filter(d => d.empresa === empresa) : todos;
      const contas = lerLocal('contas');
      mostrarConciliacao(contas, filtrado);
    }

    function conciliar() {
      const contas = lerLocal('contas');
      const dda = lerLocal('dda');
      mostrarConciliacao(contas, dda);
    }

    function mostrarConciliacao(dadosContas, dadosDDA) {
      dadosContas.sort((a, b) => parseFloat(a.valor) - parseFloat(b.valor));
      dadosDDA.sort((a, b) => parseFloat(a.valor) - parseFloat(b.valor));
      const usadosDDA = new Array(dadosDDA.length).fill(false);
      const sistemaDiv = document.getElementById('sistema');
      const bancoDiv = document.getElementById('banco');
      sistemaDiv.innerHTML = bancoDiv.innerHTML = '';
      let conciliados = 0, valorConciliado = 0;
      dadosContas.forEach(conta => {
        let index = dadosDDA.findIndex((dda, i) => !usadosDDA[i] && dda.valor === conta.valor);
        if (index !== -1) { usadosDDA[index] = true; conciliados++; valorConciliado += parseFloat(conta.valor); }
      });
      for (let conta of dadosContas) {
        const match = dadosDDA.find(d => d.valor === conta.valor);
        sistemaDiv.innerHTML += `<div class="card ${match ? 'match' : ''}"><div class="valor">R$ ${conta.valor}</div><div>${conta.cod}</div><div>${conta.fornecedor}</div></div>`;
      }
      dadosDDA.forEach((dda, i) => {
        bancoDiv.innerHTML += `<div class="card ${usadosDDA[i] ? 'match' : ''}"><div class="valor">R$ ${dda.valor} - ${dda.data}</div><div>${dda.fornecedor}</div></div>`;
      });
      const valorPendente = dadosContas.reduce((acc, el) => acc + parseFloat(el.valor), 0) - valorConciliado;
      document.getElementById("qtdeConciliado").innerText = conciliados;
      document.getElementById("qtdePendente").innerText = dadosContas.length - conciliados;
      document.getElementById("valorConciliado").innerText = valorConciliado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      document.getElementById("valorPendente").innerText = valorPendente.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function limparHistorico() {
      localStorage.removeItem('contas');
      localStorage.removeItem('dda');
      location.reload();
    }

    window.onload = () => {
      const contas = lerLocal('contas');
      const dda = lerLocal('dda');
      if (contas.length && dda.length) mostrarConciliacao(contas, dda);
    };
  </script>
</body>
</html>
