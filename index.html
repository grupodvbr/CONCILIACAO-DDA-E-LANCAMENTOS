<!-- ... (mesmo <head> e estilos anteriores, sem mudanÃ§as aqui) -->

<script>
  function mostrarArquivo(tipo) {
    const input = document.getElementById(tipo);
    let nomes = '';

    if (tipo === 'dda') {
      nomes = Array.from(input.files).map(f => f.name).join(', ');
      document.getElementById('nomePDF').innerText = nomes;
    } else {
      nomes = input.files.length ? input.files[0].name : '';
      document.getElementById('nomeExcel').innerText = nomes;
    }
  }

  function limparHistorico() {
    localStorage.removeItem('contas');
    localStorage.removeItem('dda');
    location.reload();
  }

  function salvarLocal(nome, dados) {
    localStorage.setItem(nome, JSON.stringify(dados));
  }

  function lerLocal(nome) {
    return JSON.parse(localStorage.getItem(nome) || '[]');
  }

  function lerContas(file, callback) {
    const reader = new FileReader();
    reader.onload = function (e) {
      const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      const resultados = [];
      for (let i = 1; i < data.length; i++) {
        const linha = data[i];
        if (!linha || linha.length < 9) continue;
        const valor = parseFloat(linha[8]);
        const fornecedor = linha[6] || '';
        const dataLanc = linha[4] || '';
        const cod = linha[1] || '';
        if (!isNaN(valor)) {
          resultados.push({ valor: valor.toFixed(2), fornecedor, data: dataLanc, cod });
        }
      }
      salvarLocal('contas', resultados);
      callback(resultados);
    };
    reader.readAsArrayBuffer(file);
  }

  function lerPDFs(files, callbackFinal) {
    let resultados = [];
    let arquivosLidos = 0;
    for (const file of files) {
      const reader = new FileReader();
      reader.onload = function () {
        const typedarray = new Uint8Array(this.result);
        pdfjsLib.getDocument({ data: typedarray }).promise.then(function (pdf) {
          let allText = '';
          let promises = [];
          for (let i = 1; i <= pdf.numPages; i++) {
            promises.push(
              pdf.getPage(i).then(page => page.getTextContent().then(tc => {
                const strings = tc.items.map(item => item.str);
                allText += strings.join('\n') + '\n';
              }))
            );
          }
          Promise.all(promises).then(function () {
            const linhas = allText.split('\n');
            linhas.forEach((l, i) => {
              const match = l.match(/(\d{1,3}(?:\.\d{3})*,\d{2})$/);
              if (match) {
                const valorStr = match[1].replace(/\./g, '').replace(',', '.');
                const valor = parseFloat(valorStr);
                if (!isNaN(valor)) {
                  const data = (linhas[i - 1] || '').trim();
                  const fornecedor = (linhas[i - 2] || '').trim();
                  resultados.push({ valor: valor.toFixed(2), fornecedor, data });
                }
              }
            });
            arquivosLidos++;
            if (arquivosLidos === files.length) {
              salvarLocal('dda', resultados);
              callbackFinal(resultados);
            }
          });
        });
      };
      reader.readAsArrayBuffer(file);
    }
  }

  function conciliar() {
    const fileContas = document.getElementById('contas').files[0];
    const filesDDA = document.getElementById('dda').files;
    if (!fileContas || !filesDDA.length) {
      alert("Selecione os dois arquivos.");
      return;
    }
    lerContas(fileContas, dadosContas => {
      lerPDFs(filesDDA, dadosDDA => mostrarConciliacao(dadosContas, dadosDDA));
    });
  }

  function mostrarConciliacao(dadosContas, dadosDDA) {
    dadosContas.sort((a, b) => parseFloat(a.valor) - parseFloat(b.valor));
    dadosDDA.sort((a, b) => parseFloat(a.valor) - parseFloat(b.valor));

    const usadosDDA = new Array(dadosDDA.length).fill(false);
    const sistemaDiv = document.getElementById('sistema');
    const bancoDiv = document.getElementById('banco');
    sistemaDiv.innerHTML = '';
    bancoDiv.innerHTML = '';

    let conciliados = 0;
    let valorConciliado = 0;

    const conciliadosContas = [];
    const naoConciliadosContas = [];
    dadosContas.forEach(conta => {
      let index = dadosDDA.findIndex((dda, i) => !usadosDDA[i] && dda.valor === conta.valor);
      if (index !== -1) {
        usadosDDA[index] = true;
        conciliados++;
        valorConciliado += parseFloat(conta.valor);
        conciliadosContas.push(conta);
      } else {
        naoConciliadosContas.push(conta);
      }
    });

    [...conciliadosContas, ...naoConciliadosContas].forEach(conta => {
      const match = conciliadosContas.includes(conta);
      const card = `<div class="card ${match ? 'match' : ''}">
        <div class="valor">${parseFloat(conta.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</div>
        <div>${conta.cod || ''}</div>
        <div>${conta.fornecedor}</div>
      </div>`;
      sistemaDiv.innerHTML += card;
    });

    const conciliadosDDA = [];
    const naoConciliadosDDA = [];
    dadosDDA.forEach((dda, i) => {
      if (usadosDDA[i]) {
        conciliadosDDA.push(dda);
      } else {
        naoConciliadosDDA.push(dda);
      }
    });

    [...conciliadosDDA, ...naoConciliadosDDA].forEach(dda => {
      const match = conciliadosDDA.includes(dda);
      const card = `<div class="card ${match ? 'match' : ''}">
        <div class="valor">${parseFloat(dda.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} - ${dda.data || ''}</div>
        <div>${dda.fornecedor || ''}</div>
      </div>`;
      bancoDiv.innerHTML += card;
    });

    const pendentes = dadosContas.length - conciliados;
    const valorPendente = dadosContas.reduce((acc, el) => acc + parseFloat(el.valor), 0) - valorConciliado;

    document.getElementById("qtdeConciliado").innerText = conciliados;
    document.getElementById("qtdePendente").innerText = pendentes;
    document.getElementById("valorConciliado").innerText = valorConciliado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById("valorPendente").innerText = valorPendente.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  window.onload = function () {
    const contas = lerLocal('contas');
    const dda = lerLocal('dda');
    if (contas.length && dda.length) mostrarConciliacao(contas, dda);
  }
</script>
